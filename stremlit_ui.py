import streamlit as st
from main import BookRAG
import os
import logging

logger = logging.getLogger(__name__)

st.set_page_config(
    page_title="–ö–Ω–∏–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å RAG",
    page_icon="üìö",
    layout="wide"
)

st.title("üìö –ö–Ω–∏–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å RAG")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if 'rag' not in st.session_state:
    try:
        with st.spinner('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...'):
            logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ...")
            st.session_state.rag = BookRAG()
            st.success('–°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!')
    except FileNotFoundError:
        st.error("–§–∞–π–ª book.pdf –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
        st.stop()
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã: {str(e)}")
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {str(e)}", exc_info=True)
        st.stop()

# –°–æ–∑–¥–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
with st.sidebar:
    st.header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
    available_sections = st.session_state.rag.get_available_sections()

    # –í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞
    selected_section = st.selectbox(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∫–Ω–∏–≥–∏",
        ["–í—Å—è –∫–Ω–∏–≥–∞"] + available_sections,
        index=0
    )

    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
    if st.button("–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏"):
        with st.spinner("–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤..."):
            success = st.session_state.rag.force_rebuild_embeddings()
            if success:
                st.success("–≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã!")
            else:
                st.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤")

# –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
st.subheader("–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –∫–Ω–∏–≥–µ")

# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
question = st.text_input("–í–∞—à –≤–æ–ø—Ä–æ—Å:", key="question_input")

if question:
    try:
        with st.spinner('–ò—â—É –æ—Ç–≤–µ—Ç...'):
            # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª
            if selected_section != "–í—Å—è –∫–Ω–∏–≥–∞":
                response = st.session_state.rag.search_by_section(selected_section, question)
            else:
                response = st.session_state.rag.ask_question(question)

            # –†–∞–∑–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            parts = response.split("\n\n–ò—Å—Ç–æ—á–Ω–∏–∫–∏:")
            main_answer = parts[0]
            metadata = "–ò—Å—Ç–æ—á–Ω–∏–∫–∏:" + parts[1] if len(parts) > 1 else ""

            # –í—ã–≤–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç
            st.write(main_answer)

            # –í—ã–≤–æ–¥–∏–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–ª–æ–∫–µ
            if metadata:
                with st.expander("–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞"):
                    st.write(metadata)

            logger.info("–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å")
    except Exception as e:
        error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–ø—Ä–æ—Å–∞: {str(e)}"
        logger.error(error_msg, exc_info=True)
        st.error(error_msg)

# –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ä–∞–∑–¥–µ–ª–µ
if selected_section != "–í—Å—è –∫–Ω–∏–≥–∞":
    st.info(f"üîç –ü–æ–∏—Å–∫ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ: {selected_section}")

# –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
with st.expander("‚ÑπÔ∏è –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è"):
    st.markdown("""
    1. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∫–Ω–∏–≥–∏ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ "–í—Å—è –∫–Ω–∏–≥–∞" –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º—É —Ç–µ–∫—Å—Ç—É)
    2. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
    3. –ü–æ–ª—É—á–∏—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

    **–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:**
    - "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä —É—Å–ø–µ—Ö–∞?"
    - "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–æ–º–∞–Ω–¥—ã"
    - "–ö–∞–∫ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –∫—Ä–∏–∑–∏—Å–æ–º –≤ –±–∏–∑–Ω–µ—Å–µ?"
    """)